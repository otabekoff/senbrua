name: Build & Release All Packages

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: false
        default: ""

env:
  APP_ID: uz.mohirlab.senbrua
  APP_NAME: senbrua

jobs:
  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            meson ninja-build \
            libgtk-4-dev libadwaita-1-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            gjs libgjs-dev gir1.2-gtk-4.0 gir1.2-adw-1 \
            gettext appstream-util desktop-file-utils \
            dpkg-dev fakeroot

      - name: Build with Meson
        run: |
          meson setup builddir --prefix=/usr -Dskip_ts=true
          ninja -C builddir

      - name: Create Debian package
        run: |
          VERSION=${{ steps.version.outputs.version }}
          PKG_DIR="${APP_ID}_${VERSION}-1_amd64"

          # Install to package directory
          DESTDIR="$(pwd)/${PKG_DIR}" ninja -C builddir install

          # Create DEBIAN control file
          mkdir -p "${PKG_DIR}/DEBIAN"
          cat > "${PKG_DIR}/DEBIAN/control" << EOF
          Package: ${APP_ID}
          Version: ${VERSION}-1
          Section: sound
          Priority: optional
          Architecture: amd64
          Depends: gjs, libgtk-4-1, libadwaita-1-0, libgstreamer1.0-0, libgstreamer-plugins-base1.0-0, gstreamer1.0-plugins-base, gstreamer1.0-plugins-good, gstreamer1.0-pulseaudio
          Maintainer: Otabek Sadiridinov <sadiridinovotabek@gmail.com>
          Homepage: https://github.com/otabekoff/senbrua
          Description: Modern sound recorder for GNOME
           A modern remake of Vocalis, providing simple audio recording for GNOME.
           Features include noise reduction, multiple audio formats, and real-time
           waveform visualization.
          EOF

          # Build the package
          dpkg-deb --build "${PKG_DIR}"
          mv "${PKG_DIR}.deb" "${APP_ID}_${VERSION}-1_amd64.deb"

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: "*.deb"

  build-flatpak:
    name: Build Flatpak
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:gnome-47
      options: --privileged
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Flatpak
        uses: flathub-infra/flatpak-github-actions/flatpak-builder@master
        with:
          manifest-path: uz.mohirlab.senbrua.json
          bundle: senbrua.flatpak
          cache-key: flatpak-builder-${{ github.sha }}

      - name: Upload Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-package
          path: senbrua.flatpak

  build-snap:
    name: Build Snap
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Snap
        uses: snapcore/action-build@v1
        id: snapcraft

      - name: Upload Snap
        uses: actions/upload-artifact@v4
        with:
          name: snap-package
          path: ${{ steps.snapcraft.outputs.snap }}

  build-appimage:
    name: Build AppImage
    runs-on: ubuntu-22.04
    needs: build-deb
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            meson ninja-build \
            libgtk-4-dev libadwaita-1-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            gjs libgjs-dev gir1.2-gtk-4.0 gir1.2-adw-1 \
            gettext appstream-util desktop-file-utils \
            libfuse2 file

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Build application
        run: |
          meson setup builddir --prefix=/usr -Dskip_ts=true
          ninja -C builddir

      - name: Create AppImage
        run: |
          VERSION=${{ needs.build-deb.outputs.version }}
          APPDIR="AppDir"

          # Install to AppDir
          DESTDIR="$(pwd)/${APPDIR}" ninja -C builddir install

          # Create AppRun
          cat > "${APPDIR}/AppRun" << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${HERE}/usr/local/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}"
          export XDG_DATA_DIRS="${HERE}/usr/share:${XDG_DATA_DIRS}"
          export GI_TYPELIB_PATH="${HERE}/usr/lib/girepository-1.0:${GI_TYPELIB_PATH}"

          # Find and run the application
          if [ -f "${HERE}/usr/local/bin/senbrua" ]; then
              exec "${HERE}/usr/local/bin/senbrua" "$@"
          elif [ -f "${HERE}/usr/bin/senbrua" ]; then
              exec "${HERE}/usr/bin/senbrua" "$@"
          else
              echo "Error: Could not find senbrua binary"
              exit 1
          fi
          EOF
          chmod +x "${APPDIR}/AppRun"

          # Copy icon and desktop file
          mkdir -p "${APPDIR}"
          cp data/icons/hicolor/scalable/apps/uz.mohirlab.senbrua.svg "${APPDIR}/uz.mohirlab.senbrua.svg" || true
          cp builddir/data/uz.mohirlab.senbrua.desktop "${APPDIR}/uz.mohirlab.senbrua.desktop" || true

          # Create AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage --appimage-extract-and-run "${APPDIR}" "senbrua-${VERSION}-x86_64.AppImage"

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: appimage-package
          path: "*.AppImage"

  update-apt-repo:
    name: Update APT Repository
    runs-on: ubuntu-24.04
    needs: [build-deb]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Debian package
        uses: actions/download-artifact@v4
        with:
          name: debian-package
          path: ./

      - name: Install apt-ftparchive
        run: sudo apt-get update && sudo apt-get install -y apt-utils

      - name: Update APT repository
        run: |
          VERSION=${{ needs.build-deb.outputs.version }}

          # Create directory structure
          mkdir -p apt-repo/pool/main/s/senbrua
          mkdir -p apt-repo/dists/focal/main/binary-amd64

          # Copy package
          cp *.deb apt-repo/pool/main/s/senbrua/

          # Generate Packages file
          cd apt-repo
          apt-ftparchive packages pool > dists/focal/main/binary-amd64/Packages
          gzip -c dists/focal/main/binary-amd64/Packages > dists/focal/main/binary-amd64/Packages.gz

          # Generate Release file
          cat > dists/focal/Release << EOF
          Origin: Senbrua
          Label: Senbrua
          Suite: focal
          Codename: focal
          Version: 20.04
          Architectures: amd64
          Components: main
          Description: Senbrua - Modern Sound Recorder for GNOME
          Date: $(date -Ru)
          EOF

      - name: Commit APT repository changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apt-repo/
          git commit -m "ci: update APT repository for v${{ needs.build-deb.outputs.version }}" || true
          git push

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-24.04
    needs:
      [build-deb, build-flatpak, build-snap, build-appimage, update-apt-repo]
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Senbrua v${{ needs.build-deb.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/debian-package/*.deb
            artifacts/flatpak-package/*.flatpak
            artifacts/snap-package/*.snap
            artifacts/appimage-package/*.AppImage
          body: |
            ## Installation

            ### Debian / Ubuntu (APT)
            ```bash
            # Add repository
            echo "deb [trusted=yes] https://otabekoff.github.io/senbrua focal main" | sudo tee /etc/apt/sources.list.d/senbrua.list
            sudo apt update
            sudo apt install uz.mohirlab.senbrua
            ```

            ### Debian / Ubuntu (Direct Download)
            ```bash
            wget https://github.com/otabekoff/senbrua/releases/download/v${{ needs.build-deb.outputs.version }}/uz.mohirlab.senbrua_${{ needs.build-deb.outputs.version }}-1_amd64.deb
            sudo dpkg -i uz.mohirlab.senbrua_${{ needs.build-deb.outputs.version }}-1_amd64.deb
            ```

            ### Flatpak
            ```bash
            flatpak install --user senbrua.flatpak
            ```

            ### Snap
            ```bash
            sudo snap install --dangerous senbrua_*.snap
            ```

            ### AppImage
            ```bash
            chmod +x senbrua-${{ needs.build-deb.outputs.version }}-x86_64.AppImage
            ./senbrua-${{ needs.build-deb.outputs.version }}-x86_64.AppImage
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
